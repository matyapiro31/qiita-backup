#Dockerを非ルートで使うのは危険だ
dockerコマンドのボリュームオプション-vを使えば好きなコンテナ内のディレクトリを好きなホスト内のディレクトリにマウントできますが、これをすると簡単に任意のフォルダにrootのファイルを作成できてしまいます。ユーザをグループdockerに入れるとsudoやsuなしでdockerコマンドを利用できますが、これをするとrootのパスワード無しでrootなファイルを操作することが出来ます｡

```bash
#Ubuntuのイメージを起動
docker run -v /mnt:/mnt -it ubuntu /bin/dash
#コンテナ内でコマンドを実行してみる
touch test.file
exit
#lsで確認する
ls -l /mnt
#何かrootなファイルができてることがわかる(結果略)
```
ただし毎回sudoしていると不便なので早く改善して欲しいですね。
どういう物が危険か具体的に書くと、
`sudo gpasswd -a hoge docker`
のようにするとsudoなしでdockerコマンドが使えるようになりますが、sudoなしでroot権限が手に入れられることになります。
#どんな風に危険なのか?
1. ユーザ権限の実行可能ファイルがrootのファイルを好き放題にいじれる
2. 例え管理者でなくても(=一般ユーザでも)行える
3. 特に目立った制約(いじれないファイルや厳しい条件)がない
以上より、Windowsでありがちな「何かよくわからないアプリケーションをダウンロードした」が致命傷になります。
Windowsだと絶対にUACが出ますが、これは出ない上に管理者を取られる最悪クラスです。
まあ私は知らないスクリプトなんて実行する機会は殆ど無いので大丈夫ですが。

#解決方法
そもそもLinux使いですがLPICとか受けてないので全く触らないグループの話とか知らない。なので今適当にググって出した解決法です。

``` fix.sh
#ユーザhogeをグループdockerから削除する
sudo gpasswd -d hoge docker
#グループdockerのパスワードを変更する
sudo gpasswd docker
#グループdockerにログインする
newgrp docker
```
このコマンドを実行することによってdocker使用時にパスワード一つでいいことになり、さらに管理者とは別のパスワードを使用できます。
いちいちsudo付ける必要はありません。

#ありゃ?

```
#sudoで
sudo -g docker docker command
```
とすればやっぱりパスワードなしでroot権限で実行できるぞ?
sudo -gで何でパスワードを聞かないんだ?
何か一回設定するとこうなるみたいで、解決方法は不明です。
どうもUbuntuだとgpasswd -dではグループからすぐには抜けられないようです。
idコマンドで確認するとdockerグループに入っていました。
再起動したら直りましたが、どうも元のuid/gidで動いているプロセスがある限り設定は反映されるようです。

#どうしてもDockerを使いたい時
Dockerを出来る限り安全に使うにはchattrコマンドが便利です。
このコマンドを使えばrootでさえも削除ができなくなるという優れたコマンドです。
このコマンドはext3/ext4などの拡張属性を扱うので、dockerコンテナからは通常は実行できません。mountなどもそうですが、理由は知りません。
--privilegedオプションをつけると出来るようですが、このオプションを無効化してしまえばファイルの安全は確保できます。ただ通常のコマンドからも操作できなくなります。
#さらなる対策
さらなる対策としてはAppArmorやchrootが考えられます。
前者はよく知らないんですが、多分マルウェアがrootを奪取しても大丈夫なようにするやつだったと思うので紹介します。
後者は完全に隔離環境を作れるからですね。そもそもchrootする手間があるならdocker使わない気もしますが。

#追記
Docker バージョン1.10あたりから名前空間がサポートされ、ホストとコンテナのユーザを分離することが可能になりました。
ただし、既定の設定のままでは未だに危険性は残っています。
Dockerがぶっこわれているので検証できないので記事はかけません。
